@startuml GeneracionRAG
!theme plain
!define DIRECTION left to right direction
title FASE DE GENERACI√ìN - RAG CONTEXTUAL CON √ÅMBITO AGENT INTEGRADO

start

partition "üìã ESTADO INICIAL" {
  :üéØ **ESTADO INICIAL**
  from √Åmbito Agent;
  note right
    **RECIBE DEL √ÅMBITO AGENT**:
    ‚Ä¢ question: str
    ‚Ä¢ ambito: "sostenibilidad"
    ‚Ä¢ cubos: ["energia", "residuos"]
    ‚Ä¢ came_from_clarification: bool
    ‚Ä¢ retrieved_documents: List[Document]
  end note
  
  :üìë **DOCUMENTOS + CONTEXTO**
  Validated & Filtered by √Åmbito;
  note right
    ‚Ä¢ Context validated by domain
    ‚Ä¢ Documents filtered by √°mbito
    ‚Ä¢ validate_and_clean_context()
    ‚Ä¢ Domain-specific context ready
  end note
}

partition "üîÄ TIPO DE CONSULTA" {
  if (is_consulta?) then (YES - SQL Query)
    
    partition "üíæ RAMA SQL" {
      :üíæ **SQL QUERY GENERATION**
      Context-Specific;
      note right
        **CON CONTEXTO DE √ÅMBITO**:
        ‚Ä¢ LLM: mistral-small-3.1:24b
        ‚Ä¢ rag_sql_chain['sql_query_chain']
        ‚Ä¢ Cubo-specific context
        ‚Ä¢ JSON parsing robusto
      end note
      
      :‚ö° **EXECUTE SQL QUERY**
      Filtered by √Åmbito/Cubo;
      note right
        **FILTRADO CONTEXTUAL**:
        ‚Ä¢ QuerySQLDatabaseTool
        ‚Ä¢ db_uri: sqlite:///pdi_database.db
        ‚Ä¢ Filtered by √°mbito/cubo
        ‚Ä¢ max_results: 20
      end note
      
      :üìä **SQL INTERPRETATION**
      Domain-Specific;
      note right
        **INTERPRETACI√ìN ESPEC√çFICA**:
        ‚Ä¢ sql_interpretation_chain
        ‚Ä¢ LLM: mistral-small-3.1:24b
        ‚Ä¢ √Åmbito-specific interpretation
        ‚Ä¢ context + sql_result ‚Üí answer
      end note
    }
    
  else (NO - Regular RAG)
    
    partition "ü§ñ RAMA RAG" {
      :ü§ñ **RAG GENERATION**
      with √Åmbito Context;
      note right
        **GENERACI√ìN CONTEXTUAL**:
        ‚Ä¢ LLM: mistral-small-3.1:24b
        ‚Ä¢ temperature: 0.15
        ‚Ä¢ max_tokens: 2048
        ‚Ä¢ Contexto espec√≠fico del √°mbito
        ‚Ä¢ answer_chain.invoke()
      end note
    }
    
  endif
}

partition "üéØ EVALUACI√ìN GRANULAR" {
  :üéØ **EVALUACI√ìN GRANULAR**
  Domain-Aware;
  note right
    **EVALUACI√ìN POR √ÅMBITO**:
    ‚Ä¢ LLM: llama3.2:3bm
    ‚Ä¢ granular_evaluator.invoke()
    ‚Ä¢ Evaluaci√≥n contextual por √°mbito
    ‚Ä¢ M√©tricas espec√≠ficas del dominio
  end note
  
  :üìà **EVALUATION METRICS**
  Enhanced with Domain Context;
  note right
    **M√âTRICAS GRANULARES**:
    ‚Ä¢ faithfulness ‚â• 0.7 (fidelidad al √°mbito)
    ‚Ä¢ context_precision ‚â• 0.7 (precisi√≥n contextual)
    ‚Ä¢ context_recall ‚â• 0.7 (cobertura del √°mbito)
    ‚Ä¢ answer_relevance ‚â• 0.7 (relevancia espec√≠fica)
    ‚Ä¢ diagnosis: Dict[str, str] detallado
  end note
}

partition "‚öñÔ∏è ESTRATEGIA ADAPTATIVA" {
  if (M√©tricas OK?) then (YES)
    
    :‚úÖ **RESPUESTA FINAL**
    with √Åmbito Context;
    note right
      **OUTPUT COMPLETO**:
      ‚Ä¢ generation: str
      ‚Ä¢ evaluation_metrics: Dict
      ‚Ä¢ ambito: "sostenibilidad" (preserved)
      ‚Ä¢ cubos: ["energia", "residuos"] (used)
      ‚Ä¢ Contexto acad√©mico completo
    end note
    
  else (NO - Need Retry)
    
    if (retry_count < MAX_RETRIES?) then (YES)
      
      if (Context Recall < 0.7?) then (YES)
        :üìè **STRATEGY ‚Üí 1024**
        √Åmbito Context Expansion;
        note right
          ‚Ä¢ Ampliaci√≥n contextual del √°mbito
          ‚Ä¢ chunk_strategy = '1024'
          ‚Ä¢ Mantener filtros de √°mbito
        end note
        
      elseif (Precision/Faithfulness < 0.7?) then (YES)
        :üéØ **STRATEGY ‚Üí 256**
        Cubo-Specific Focus;
        note right
          ‚Ä¢ Enfoque espec√≠fico del cubo
          ‚Ä¢ chunk_strategy = '256'
          ‚Ä¢ Filtrado m√°s granular
        end note
        
      else (Answer Relevance < 0.7)
        :üîÑ **STRATEGY CYCLE**
        Domain-Aware Alternation;
        note right
          ‚Ä¢ 512‚Üí1024‚Üí256‚Üí512
          ‚Ä¢ Alternancia por √°mbito
          ‚Ä¢ Preservar contexto del dominio
        end note
        
      endif
      
      :üîÑ **INCREMENT RETRY**
      Preserve √Åmbito State;
      note right
        ‚Ä¢ retry_count++
        ‚Ä¢ MAX_RETRIES: 3
        ‚Ä¢ Nueva iteraci√≥n con √°mbito
        ‚Ä¢ Preservar estado del √Åmbito Agent
      end note
      
      :üîÑ **NUEVA ITERACI√ìN**
      with Enhanced Context;
      
    else (NO - Max Retries)
      :‚ùå **MAX RETRIES REACHED**
      Return Best Attempt;
    endif
    
  endif
}

stop

@enduml 
digraph GeneracionRAG {
    // Configuraci√≥n general para layout horizontal
    rankdir=LR;
    ranksep=2.0;
    nodesep=1.0;
    splines=ortho;
    
    // Estilos de nodos
    node [fontname="Arial", fontsize=10, margin=0.15];
    edge [fontname="Arial", fontsize=9];
    
    // NIVEL 0: Estado inicial con √°mbito
    {rank=same; initial_state}
    initial_state [shape=box, style="rounded,filled", fillcolor="#E1F5FE",
                   label="üéØ ESTADO INICIAL\n‚Ä¢ question: str\n‚Ä¢ ambito: str (del √Åmbito Agent)\n‚Ä¢ cubos: List[str] identificados\n‚Ä¢ came_from_clarification: bool"];
    
    // NIVEL 1: Entrada con documentos recuperados
    {rank=same; input_docs}
    input_docs [shape=box, style="rounded,filled", fillcolor="#E3F2FD",
                label="üìë DOCUMENTOS + CONTEXTO\n‚Ä¢ retrieved_documents: List[Document]\n‚Ä¢ context: str validado y filtrado por √°mbito\n‚Ä¢ question: str limpia\n‚Ä¢ ambito + cubos contextualizados\n‚Ä¢ validate_and_clean_context()"];
    
    // NIVEL 2: Decisi√≥n de tipo de consulta
    {rank=same; query_type}
    query_type [shape=diamond, style="filled", fillcolor="#FFF3E0",
                label="üîÄ TIPO DE CONSULTA\n¬øis_consulta?\n(Detectado por √Åmbito Agent)"];
    
    // NIVEL 3A: Rama RAG est√°ndar
    {rank=same; rag_generation}
    rag_generation [shape=box, style="rounded,filled", fillcolor="#E8F5E8",
                    label="ü§ñ RAG GENERATION\n‚Ä¢ LLM: mistral-small-3.1:24b\n‚Ä¢ temperature: 0.15\n‚Ä¢ max_tokens: 2048\n‚Ä¢ answer_chain.invoke()\n‚Ä¢ Contexto espec√≠fico del √°mbito\n‚Ä¢ context + question ‚Üí answer"];
    
    // NIVEL 3B: Rama SQL
    {rank=same; sql_query_gen, sql_execute, sql_interpret}
    sql_query_gen [shape=box, style="rounded,filled", fillcolor="#FFF8E1",
                   label="üíæ SQL QUERY GENERATION\n‚Ä¢ LLM: mistral-small-3.1:24b\n‚Ä¢ rag_sql_chain['sql_query_chain']\n‚Ä¢ Contexto espec√≠fico por cubo\n‚Ä¢ context + question ‚Üí sql_query\n‚Ä¢ JSON parsing robusto"];
    
    sql_execute [shape=box, style="rounded,filled", fillcolor="#F1F8FF",
                 label="‚ö° EXECUTE SQL QUERY\n‚Ä¢ QuerySQLDatabaseTool\n‚Ä¢ db_uri: sqlite:///pdi_database.db\n‚Ä¢ dialect: sqlite\n‚Ä¢ max_results: 20\n‚Ä¢ Filtrado por √°mbito/cubo\n‚Ä¢ Error handling contextual"];
    
    sql_interpret [shape=box, style="rounded,filled", fillcolor="#F0FFF0",
                   label="üìä SQL INTERPRETATION\n‚Ä¢ sql_interpretation_chain\n‚Ä¢ LLM: mistral-small-3.1:24b\n‚Ä¢ Contexto original + resultados\n‚Ä¢ Interpretaci√≥n espec√≠fica del √°mbito\n‚Ä¢ context + sql_result ‚Üí answer"];
    
    // NIVEL 4: Evaluaci√≥n granular (com√∫n para ambas ramas)
    {rank=same; granular_eval}
    granular_eval [shape=box, style="rounded,filled", fillcolor="#FDF2F8",
                   label="üéØ EVALUACI√ìN GRANULAR\n‚Ä¢ LLM: llama3.2:3bm\n‚Ä¢ granular_evaluator.invoke()\n‚Ä¢ question + documents + generation\n‚Ä¢ Evaluaci√≥n contextual por √°mbito\n‚Ä¢ M√©tricas espec√≠ficas del dominio"];
    
    // NIVEL 5: M√©tricas de evaluaci√≥n (subgrafo)
    {rank=same; metrics}
    metrics [shape=record, style="filled", fillcolor="#FFFDE7",
             label="üìà EVALUATION METRICS\n‚Ä¢ faithfulness ‚â• 0.7 (fidelidad al √°mbito)\n‚Ä¢ context_precision ‚â• 0.7 (precisi√≥n contextual)\n‚Ä¢ context_recall ‚â• 0.7 (cobertura del √°mbito)\n‚Ä¢ answer_relevance ‚â• 0.7 (relevancia espec√≠fica)\n‚Ä¢ diagnosis: Dict[str, str] detallado\n‚Ä¢ domain_alignment: float (nuevo)"];
    
    // NIVEL 6: Decisi√≥n de estrategia adaptativa
    {rank=same; route_strategy}
    route_strategy [shape=diamond, style="filled", fillcolor="#FFF3E0",
                    label="‚öñÔ∏è ROUTE NEXT STRATEGY\n¬øM√©tricas OK?\n¬øretry_count < MAX_RETRIES?\nConsideraci√≥n del √°mbito"];
    
    // NIVEL 7A: Salida exitosa
    {rank=same; final_answer}
    final_answer [shape=box, style="rounded,filled", fillcolor="#F0F9FF",
                  label="‚úÖ RESPUESTA FINAL\n‚Ä¢ generation: str\n‚Ä¢ evaluation_metrics: Dict\n‚Ä¢ ambito: str preservado\n‚Ä¢ cubos: List[str] utilizados\n‚Ä¢ Contexto acad√©mico completo"];
    
    // NIVEL 7B: Estrategias de reintento contextuales
    {rank=same; strategy_1024, strategy_256, strategy_cycle, increment_retry}
    
    strategy_1024 [shape=box, style="rounded,filled", fillcolor="#FFE0B2",
                   label="üìè STRATEGY ‚Üí 1024\n‚Ä¢ Context Recall < 0.7\n‚Ä¢ Ampliaci√≥n contextual del √°mbito\n‚Ä¢ chunk_strategy = '1024'\n‚Ä¢ Mantener filtros de √°mbito"];
    
    strategy_256 [shape=box, style="rounded,filled", fillcolor="#FFCDD2",
                  label="üéØ STRATEGY ‚Üí 256\n‚Ä¢ Precision/Faithfulness < 0.7\n‚Ä¢ Enfoque espec√≠fico del cubo\n‚Ä¢ chunk_strategy = '256'\n‚Ä¢ Filtrado m√°s granular"];
    
    strategy_cycle [shape=box, style="rounded,filled", fillcolor="#D1C4E9",
                    label="üîÑ STRATEGY CYCLE\n‚Ä¢ Answer Relevance < 0.7\n‚Ä¢ 512‚Üí1024‚Üí256‚Üí512\n‚Ä¢ Alternancia inteligente por √°mbito\n‚Ä¢ Preservar contexto del dominio"];
    
    increment_retry [shape=box, style="rounded,filled", fillcolor="#FFAB91",
                     label="üîÑ INCREMENT RETRY\n‚Ä¢ retry_count++\n‚Ä¢ MAX_RETRIES: 3\n‚Ä¢ Nueva iteraci√≥n con √°mbito\n‚Ä¢ Detecci√≥n bucle infinito\n‚Ä¢ Preservar estado del √Åmbito Agent"];
    
    // NIVEL 8: Configuraci√≥n contextual
    {rank=same; retry_config, ambito_info}
    retry_config [shape=record, style="filled", fillcolor="#F3E5F5",
                  label="‚öôÔ∏è RETRY CONFIGURATION\n‚Ä¢ MAX_RETRIES: 3\n‚Ä¢ EVALUATION_THRESHOLDS\n‚Ä¢ adaptive_retrieval: true\n‚Ä¢ insufficient_info detection\n‚Ä¢ recursion_limit: 50\n‚Ä¢ domain_awareness: enabled"];
    
    ambito_info [shape=record, style="filled", fillcolor="#E1F5FE",
                 label="üéØ CONTEXTO √ÅMBITO\n‚Ä¢ ambito identificado\n‚Ä¢ cubos relevantes\n‚Ä¢ confidence score\n‚Ä¢ visualization flags\n‚Ä¢ domain-specific filtering"];
    
    // CONEXIONES PRINCIPALES
    initial_state -> input_docs [label="Contexto enriquecido"];
    input_docs -> query_type;
    
    // Rama RAG
    query_type -> rag_generation [label="Consulta regular\ncon contexto de √°mbito"];
    rag_generation -> granular_eval;
    
    // Rama SQL
    query_type -> sql_query_gen [label="is_consulta=true\n(espec√≠fica del cubo)"];
    sql_query_gen -> sql_execute;
    sql_execute -> sql_interpret;
    sql_interpret -> granular_eval;
    
    // Evaluaci√≥n com√∫n
    granular_eval -> route_strategy;
    
    // Decisiones de estrategia
    route_strategy -> final_answer [label="M√©tricas OK"];
    route_strategy -> strategy_1024 [label="Context Recall < 0.7"];
    route_strategy -> strategy_256 [label="Precision/Faith < 0.7"];
    route_strategy -> strategy_cycle [label="Answer Rel < 0.7"];
    
    // Reintentos contextuales
    strategy_1024 -> increment_retry;
    strategy_256 -> increment_retry;
    strategy_cycle -> increment_retry;
    increment_retry -> input_docs [label="Nueva iteraci√≥n\ncon contexto preservado", constraint=false, style=dashed];
    
    // Conexiones de configuraci√≥n
    granular_eval -> metrics [style=dashed, color=gray];
    route_strategy -> retry_config [style=dashed, color=gray];
    initial_state -> ambito_info [style=dashed, color=blue];
    
    // T√≠tulo del diagrama
    labelloc="t";
    label="FASE DE GENERACI√ìN - RAG CONTEXTUAL CON √ÅMBITO AGENT INTEGRADO";
    fontsize=14;
    fontname="Arial Bold";
} 